-- Esquema de base de datos para el chat assistant con UIMessage

-- Tabla de threads (conversaciones)
CREATE TABLE IF NOT EXISTS threads (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Tabla de mensajes adaptada para UIMessage
CREATE TABLE IF NOT EXISTS messages (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  thread_id UUID REFERENCES threads(id) ON DELETE CASCADE,
  role TEXT NOT NULL, -- 'user', 'assistant', 'system', etc.
  content JSONB NOT NULL, -- Contenido completo del mensaje como JSON
  parts JSONB NOT NULL, -- Array de partes del mensaje (text, image, etc.)
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Índices para mejorar el rendimiento
CREATE INDEX IF NOT EXISTS idx_messages_thread_id ON messages(thread_id);
CREATE INDEX IF NOT EXISTS idx_messages_created_at ON messages(created_at);
CREATE INDEX IF NOT EXISTS idx_threads_created_at ON threads(created_at);

-- Función para actualizar updated_at automáticamente
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

-- Triggers para actualizar updated_at
CREATE TRIGGER update_threads_updated_at 
  BEFORE UPDATE ON threads 
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_messages_updated_at 
  BEFORE UPDATE ON messages 
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Comentarios sobre la estructura
COMMENT ON TABLE threads IS 'Tabla para almacenar conversaciones/threads de chat';
COMMENT ON TABLE messages IS 'Tabla para almacenar mensajes de chat con estructura UIMessage';
COMMENT ON COLUMN messages.content IS 'Contenido completo del mensaje en formato JSON';
COMMENT ON COLUMN messages.parts IS 'Array de partes del mensaje (text, image, tool calls, etc.)';
COMMENT ON COLUMN messages.role IS 'Rol del mensaje: user, assistant, system, tool, etc.';
